{%- for vm, vm_config in provider_config.resources.vms.items() %}
{%-   if vm_config.module == module %}
{%-    set memory = (vm_config.memory|default(1024)/1024)|round|int|string %}
{%-    set cpus = (vm_config.num_cpus)|default(1)|string %}
# Resource {{ provider }} virtual machine
resource "digitalocean_droplet" "{{ vm.split('.')[0]|replace('-','_') }}" {
  count    = {{ vm_config.count|default(1) }}
  name     = format("{{ vm.split('.')[0] }}-%02s.%s.%s", count.index + 1, var.environment, var.do_domain)
  image    = "{{ vm_config.image }}"
  region   = var.do_region
  size     = "{{ 's-'+cpus+'vcpu-'+memory+'gb' }}"
  ssh_keys = var.do_ssh_keys
  private_networking = {{ vm_config.private_networking|default(false)|lower }}
{%-    if vm_config.tags %}
{%-      set tags = [] %}
{%-      for tag in vm_config.tags %}
{%-        set tag_id = 'digitalocean_tag.'+tag|replace('-','_')+'.id' %}
{%-        set _ = tags.append(tag_id) %}
{%-        set tag_id_env = 'digitalocean_tag.'+tag|replace('-','_')+'_env.id' %}
{%-        set _ = tags.append(tag_id_env) %}
{%-      endfor %}
  tags     = {{ tags|replace('\'', '') }}
{%-    endif %}
}
{%-   endif %}
{%- endfor %}
