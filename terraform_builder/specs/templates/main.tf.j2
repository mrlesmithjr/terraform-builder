# Generated using https://github.com/mrlesmithjr/terraform-builder
{%- if module == 'root' %}
{%-   if args.backends.remote is not defined or (args.backends.remote is defined and args.backends.remote == {}) %}
# Backend local config
terraform {
    backend "local" {
        path = "terraform.tfstate"
    }
}
{%-   endif %}
{%-   for provider, config in args.providers.items() %}
{%-     if config != {} %}
# Provider {{ provider }} config
provider "{{ provider|lower }}" {
{%-       if provider|lower == 'azurerm' %}
    environment     = var.azurerm_environment
    features        = var.azurerm_features
    subscription_id = var.azurerm_subscription_id
    tenant_id       = var.azurerm_tenant_id
{%-       elif provider|lower == 'digitalocean' %}
    api_endpoint = var.do_api_endpoint
    token        = var.do_token
{%-       elif provider|lower == 'vsphere' %}
    allow_unverified_ssl = var.vsphere_allow_unverified_ssl
    password = var.vsphere_password
    user = var.vsphere_username
    vsphere_server = var.vsphere_server
{%-       endif %}
}
{%-     endif -%}
{%-   endfor %}
{%-   for environment in args.environments %}
# Module {{ environment }} config
module "{{ environment }}" {
    source = "./environments/{{ environment }}"
}
{%-   endfor %}
# Setting required Terraform version or greater
terraform {
  required_version = ">= 0.12"
}
{%- elif module in args.environments %}
{%-   set module_env = module %}
{%-   for module in args.modules %}
{%-     if module != 'root' %}
# Module {{ module }} config
module "{{ module }}" {
    source      = "../../modules/{{ module }}"
    environment = "{{ module_env }}"
{%-         set vm_providers = [] %}
{%-         for vm, config in args.resources.vms.items() %}
{%-           if config.module == module %}
{%-             set _ = vm_providers.append(config.provider) %}
{%-           endif %}
{%-         endfor %}
{%-         for provider, provider_config in args.providers.items() -%}
{%-           if provider in vm_providers %}
{%-           if provider_config != {} -%}
{%-             if provider_config['variables'] -%}
{%-               for variable, variable_config in provider_config['variables'].items() %}
    {{ variable }} = "{{ variable_config.default }}"
{%-               endfor %}
{%-             endif -%}
{%-           endif -%}
{%-           endif %}
{%-         endfor %}
}
{%-    endif %}
{%-  endfor -%}
{% endif %}